<!DOCTYPE html>
<html>
<head>
    <title>Calendar Test App for Accompli Interview</title>
    <meta charset='utf-8' />
    <link rel='stylesheet' href='fullcalendar/fullcalendar.css' />
    <script src='fullcalendar/lib/jquery.min.js'></script>
    <script src='fullcalendar/lib/moment.min.js'></script>
    <script src='fullcalendar/fullcalendar.js'></script>
    <script>
        var client_id = "165092632195-qfpg6do51ecs55teh3vapiom40kentk0.apps.googleusercontent.com";
        var api_key = "z1alvNSMkWU_vOaMG7n16F7V";
        var scopes = "https://www.googleapis.com/auth/calendar email"; 

        function handleClientLoad() {
            gapi.client.setApiKey(api_key);
            window.setTimeout(checkAuth,1);
        }

        function checkAuth() {
            var config = {
                'client_id': client_id,
                'scope': scopes,
                'immediate': true
            };
            gapi.auth.authorize(config, function(authResult) {
                if (authResult && !authResult.error) {
                    console.log('login succeeded');
                    console.log(gapi.auth.getToken().access_token);
                    getUserEmail();
                } else {
                    if (authResult && authResult.error)
                        console.log('login failed ' + authResult.error);
                    else
                        console.log('login failed')
                    alert('login failed');
                }
            });
        }

        function getUserEmail() {
            var url = "https://www.googleapis.com/oauth2/v1/userinfo?access_token=" + gapi.auth.getToken()["access_token"];
            $.get(url, function(result) {
                email = result.email;
                if (email) {
                    console.log('got email:' + email);
                    register(email);
                }
            });
        }

        function register(email) {
            var url = "http://localhost:3000/users";
            var data = {
                "user": {
                    "email": email,
                    "access_token": gapi.auth.getToken().access_token,
                }
            };
            $.post(url, data, function(result) {
                console.log(result);
            });
        }
    </script>
    <script src="https://apis.google.com/js/client.js?onload=handleClientLoad"></script>

    <script>

        $(document).ready(function() {

            $('#calendar').fullCalendar({
                editable: true,
                eventLimit: true, // allow "more" link when too many events
                events: [
                {
                    title: 'All Day Event',
                    start: '2014-11-01'
                },
                {
                    title: 'Long Event',
                    start: '2014-11-07',
                    end: '2014-11-10'
                },
                {
                    id: 999,
                    title: 'Repeating Event',
                    start: '2014-11-09T16:00:00'
                },
                {
                    id: 999,
                    title: 'Repeating Event',
                    start: '2014-11-16T16:00:00'
                },
                {
                    title: 'Conference',
                    start: '2014-11-11',
                    end: '2014-11-13'
                },
                {
                    title: 'Meeting',
                    start: '2014-11-12T10:30:00',
                    end: '2014-11-12T12:30:00'
                },
                {
                    title: 'Lunch',
                    start: '2014-11-12T12:00:00'
                },
                {
                    title: 'Meeting',
                    start: '2014-11-12T14:30:00'
                },
                {
                    title: 'Happy Hour',
                    start: '2014-11-12T17:30:00'
                },
                {
                    title: 'Dinner',
                    start: '2014-11-12T20:00:00'
                },
                {
                    title: 'Birthday Party',
                    start: '2014-11-13T07:00:00'
                },
                {
                    title: 'Click for Google',
                    url: 'http://google.com/',
                    start: '2014-11-28'
                }
            ]
            });
        });
    </script>
    <style>
        body {
            margin: 40px 10px;
            padding: 0;
            font-family: "Lucida Grande",Helvetica,Arial,Verdana,sans-serif;
            font-size: 14px;
        }
        #calendar {
            max-width: 900px;
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <div id='calendar'></div>
</body>
</html>